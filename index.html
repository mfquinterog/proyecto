<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <title>Números</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
      body {
        background-color: #DCE6F1;
      }

      #resultado {
        font-weight: bold;
        font-size: 6rem;
        text-align: center;
      }

      .canvas-container {
        margin: 0 auto;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <main>
      <!-- Header Section -->
      <div class="px-4 py-2 my-2 text-center border-bottom">
        <img class="d-block mx-auto mb-2" src="ubosque.png" alt="Logo Universidad" width="250" height="150">
        <h1 class="display-5 fw-bold">PREDICCI&Oacute;N DE N&Uacute;MEROS ESCRITOS A MANO</h1>
        <div class="col-lg-6 mx-auto">
          <p class="display-5 fw-bold">Dibuja un número y observa cómo el modelo lo predice en tiempo real</p>
          <p class="lead mb-0">Maria Fernanda Quintero Gaona</p>
          <p class="lead mb-0">Maria Alejandra Marin</p>
          <p class="lead mb-4">Rubén Steven Rond&oacute;n Ni&ntilde;o</p>
        </div>
      </div>

      <!-- Canvas Section -->
      <div class="container mt-5">
        <div class="row">
          <div class="col-12 col-md-4 offset-md-4">
            <div id="canvas-container">
              <div><i>Dibuje un n&uacute;mero entre 0 y 9 para hacer una predicci&oacute;n</i></div>
              <canvas id="bigcanvas" width="200" height="200"></canvas>
              <canvas id="smallcanvas" width="28" height="28" style="display: none"></canvas>
            </div>
            <div class="text-center mt-3">
              <button class="btn btn-primary" id="limpiar" onclick="limpiar()"><i class="fas fa-eraser"></i> Limpiar</button>
              <button class="btn btn-success" id="predecir" onclick="predecir()" disabled><i class="fas fa-robot"></i> Predecir</button>
              <div id="resultado"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Section -->
      <footer style="background-color: #A4C639; color: #ffffff;" class="mt-5 px-4 py-2 text-center">
        <div class="py-5">
          <h1 class="display-5 fw-bold">CURSO: Curso Architecting with Google Compute Engine</h1>
          <div class="col-lg-6 mx-auto">
            <p class="fs- mt-4">
              Datos utilizados: MNIST dataset. Yann LeCun, Corinna Cortes, and Christopher J.C. Burges. 
              <a href="http://yann.lecun.com/exdb/mnist/" target="_blank">The MNIST Database of Handwritten Digits</a>.
            </p>
            <p class="fs-5 mb-4">Maestría: Estadística Aplicada y Ciencia de Datos</p>
          </div>
        </div>
      </footer>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="fabric.min.js"></script>
    <script src="dibujo.js"></script>

    <script>
      var modelo = null;

      // Set up canvas
      var canvas = document.getElementById("bigcanvas");
      var ctx1 = canvas.getContext("2d");
      var smallcanvas = document.getElementById("smallcanvas");
      var ctx2 = smallcanvas.getContext("2d");

      function limpiar() {
        ctx1.clearRect(0, 0, canvas.width, canvas.height);
        drawingcanvas.clear();
      }

      function predecir() {
        if (modelo === null) {
          console.error("El modelo no se ha cargado todavía.");
          return;
        }

        // Resize canvas to 28x28
        resample_single(canvas, 28, 28, smallcanvas);

        var imgData = ctx2.getImageData(0, 0, 28, 28);
        var arr = [];
        var arr28 = [];
        for (var p = 0, i = 0; p < imgData.data.length; p += 4) {
          var valor = imgData.data[p + 3] / 255;
          arr28.push([valor]);
          if (arr28.length == 28) {
            arr.push(arr28);
            arr28 = [];
          }
        }

        arr = [arr];
        var tensor4 = tf.tensor4d(arr);
        var resultados = modelo.predict(tensor4).dataSync();
        var mayorIndice = resultados.indexOf(Math.max.apply(null, resultados));

        console.log("Predicción", mayorIndice);
        const resultadoElemento = document.getElementById("resultado");
        resultadoElemento.style.fontSize = "3rem";
        resultadoElemento.style.color = "green";
        resultadoElemento.innerHTML = "Predicción: " + mayorIndice;
      }

      function resample_single(canvas, width, height, resize_canvas) {
        // Resize logic
      }

      console.log("Intentando cargar el modelo desde model.json...");

      // Load model
      (async () => {
        try {
          modelo = await tf.loadGraphModel('./model.json');
          console.log("Modelo cargado correctamente.");
          document.getElementById("predecir").disabled = false;
        } catch (error) {
          console.error("Error al cargar el modelo:", error);
        }
      })();
    </script>
  </body>
</html>
